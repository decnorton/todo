/*! 
	main.js
	
	Author: Declan Norton <decnorton.com>
*/Storage.prototype.setObject=function(e,t){this.setItem(e,JSON.stringify(t))};Storage.prototype.getObject=function(e){var t=this.getItem(e);return t&&JSON.parse(t)};$(document).ready(function(){if(!Modernizr.localstorage){alert("Your browser doesn't support local storage!");return}var e=function(){};e=function(){this.data={};this.tasks=$("ul.tasks");this.item=$('<li>					<div class="status">						<input type="checkbox">						<label></label>					</div>					<span class="content"></span>					<time class="date"></time>					<a class="remove">&times;</a>				</li>')};e.prototype={init:function(){this.loadLocal()},loadLocal:function(){this.data=localStorage.getObject("data");if(this.data==null)this.data={};else{var e=[],t=[];for(var n in this.data){var r=this.data[n];r.done?e.push(r):t.push(r)}var i=e.concat(t);for(var s=0;s<i.length;s++){var r=i[s];this.addTask(r)}}},addTask:function(e){$(".zilch").hide();if($('[data-id="'+e.id+'"]').length>0)return;var t=this.item.clone();t.attr("data-id",e.id);$(".content",t).html(e.content);if(e.done){t.addClass("done");$(":checkbox",t).prop("checked",!0)}else{t.removeClass("done");$(":checkbox",t).prop("checked",!1)}this.tasks.prepend(t);t.hide();t.css("opacity",0);t.width(100);t.slideDown(100,function(){t.width("");t.animate({opacity:1})})},newTask:function(e){this.data[e.id]=e;this.update();this.addTask(e)},updateTask:function(e,t){if(t.length>0){this.data[e].content=t;this.update()}},toggleTask:function(e){this.data[e].done===!0?this.setAsNotDone(e):this.setAsDone(e)},setAsDone:function(e){this.data[e].done=!0;this.update();var t=$('[data-id="'+e+'"]');$(":checkbox",t).prop("checked",!0);$("li:not(.done)").length>1&&console.log("more than one task");t.is("li:first")&&$("li:not(.done)").length<2?t.addClass("done"):t.animate({opacity:0},100,function(){t.slideUp(100,function(){t.remove();$("li.done",".tasks").length>0?t.insertBefore("li.done:first",".tasks"):t.appendTo(".tasks");t.addClass("done");t.slideDown(100,function(){t.animate({opacity:1},100)})})})},setAsNotDone:function(e){this.data[e].done=!1;this.update();var t=$('[data-id="'+e+'"]');$(":checkbox",t).prop("checked",!1);t.is("li:first")?t.removeClass("done"):t.animate({opacity:0},100,function(){t.slideUp(100,function(){t.remove();$(".tasks").prepend(t);t.removeClass("done");t.slideDown(100,function(){t.animate({opacity:1},100)})})})},removeTask:function(e){delete this.data[e];this.update();$('[data-id="'+e+'"]').animate({opacity:0},100,function(){$(this).slideUp(100,function(){$(this).remove();$("li",".tasks").length<=0&&$(".zilch").show()})})},update:function(){localStorage.setObject("data",this.data)},clearData:function(){localStorage.setObject("data",{})},toXML:function(){var e='<?xml version="1.0" encoding="UTF-8"?>\n';e+="<todo>\n";for(var t in this.data){var n=this.data[t];e+="	<task>\n";e+="		<id>"+n.id+"</id>\n";e+="		<content>"+n.content+"</content>\n";e+="		<date>"+n.date+"</date>\n";e+="		<timestamp>"+n.timestamp+"</timestamp>\n";e+="		<done>"+n.done+"</done>\n";e+="	</task>\n"}e+="</todo>";return e},fromXML:function(e){var t=this,n=!1;$(e).find("task").each(function(){n=!0;var e;$(this).find("done").text()=="false"?e=!1:e=!0;var r={id:$(this).find("id").text(),content:$(this).find("content").text(),date:$(this).find("date").text(),timestamp:$(this).find("timestamp").text(),done:e};t.newTask(r)});n||alert("Invalid XML!")},modal:function(){$("body").addClass("modal")},dismissModal:function(){$("body").removeClass("modal");$(".modal-content").removeClass("import export");$("form",".modal-content").off("submit")},importModal:function(){var e=this,t=$(".modal-content");t.addClass("import");$(".title",t).html("Import XML");$(".description",t).html("Import XML");var n='<textarea name="xml-text" placeholder="Paste your XML here..."></textarea>';window.File&&window.FileReader&&window.FileList&&window.Blob&&(n+='<p class="or">or</p><input type="file" name="xml-file" accept="application/xml">');n+='<input type="submit" value="Import">';$("form",t).html(n).on("submit",function(t){var n=$('[name="xml-file"]')[0].files[0];if(n!=null){var r=new FileReader;r.onload=function(t){return function(t){var n=t.target.result;e.fromXML(n)}}(n);r.readAsText(n)}else{var i=$('[name="xml-text"]',this).val();e.fromXML(i)}e.dismissModal();t.preventDefault();return!1});this.modal()},exportModal:function(){var e=this,t=$(".modal-content");t.addClass("export");$(".title",t).html("Export XML");$(".description",t).html("");var n=this.toXML();$("form",t).html('<a class="download">Download</a><br><textarea name="export-xml">'+n+"</textarea>");$(".download",t).on("click",function(t){var n="data:application/xml,"+encodeURIComponent(e.toXML());newWindow=window.open(n,"newDocument")});this.modal()}};var t=new e;t.init();var n=$(".new-task");n.on("submit",function(e){e.preventDefault();var n=$('[name="thing"]',this),r=$('[name="date"]',this),i={id:uniqid(),content:n.val(),date:r.val(),timestamp:time(),done:!1};n.val("");r.val("");t.newTask(i);return!1});$(document).on("click",".tasks li .remove",function(e){var n=$(this).parent().data("id");t.removeTask(n)});$(document).on("dblclick",".tasks li .content",function(e){if($(this).parent().hasClass("done"))return;var t=$(this).parent().data("id");$(this).parent().addClass("editing");$(this).prop("contenteditable",!0).focus()}).on("keydown",".tasks li .content",function(e){if(e.keyCode==13){e.preventDefault();$(this).blur()}}).on("blur",".tasks li .content",function(e){var n=$(this).parent().data("id");$(this).parent().removeClass("editing");$(this).prop("contenteditable",!1);$(this).html().length<=0&&$(this).html(t.data[n].content);t.updateTask(n,$(this).html())});$(document).on("change",".tasks li .status :checkbox",function(e){var n=$(this).parent().parent().data("id");t.toggleTask(n)});$(document).on("keyup",function(e){e.keyCode==88&&console.log(t.toXML())});$(".button-import").on("click",function(e){t.importModal()});$(".button-export").on("click",function(e){t.exportModal()});$(".modal-cover").on("click",function(e){t.dismissModal()})});